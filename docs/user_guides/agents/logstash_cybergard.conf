##############################
# Logstash pipeline example for CyberGard
# Path: docs/user_guides/agents/logstash_cybergard.conf
# Purpose: Accept Beats input, normalize events, and POST to CyberGard API
##############################
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/pki/tls/certs/logstash.crt"
    ssl_certificate_key => "/etc/pki/tls/private/logstash.key"
  }
}

filter {
  # Example: normalize common fields into a simple JSON structure
  mutate {
    add_field => { "[@metadata][cybergard_event]" => "true" }
  }

  # Timestamp handling
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
    remove_field => ["timestamp"]
  }

  # Build the structure expected by CyberGard API
  ruby {
    code => "event.set('cybergard_payload', { 'timestamp' => event.get('@timestamp').iso8601, 'details' => event.to_hash })"
  }
}

output {
  # Post JSON to CyberGard ingestion API (requires logstash-output-http plugin)
  http {
    url => "https://cybergard.example.com/api/v1/logs/ingest"
    http_method => "post"
    format => "json"
    headers => {
      "Content-Type" => "application/json"
      "Authorization" => "Bearer YOUR_API_KEY_HERE"
    }
    mapping => {
      "timestamp" => "%{[cybergard_payload][timestamp]}"
      "details" => "%{[cybergard_payload][details]}"
    }
    # increase retry options in production
    retry_max_interval => 60
    retry_initial_interval => 5
  }

  # Optional: also keep a local file copy for auditing
  file {
    path => "/var/log/logstash/cybergard_events_%{+YYYY-MM-dd}.json"
    codec => json_lines
  }
}
