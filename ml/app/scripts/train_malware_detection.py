"""
Training Script for Malware Detection Model
Trains static + behavioral malware detection using process events
"""

import os
import sys
import json
import argparse
import glob
import time
from datetime import datetime
from typing import List, Dict, Any
import numpy as np

# Add parent directory to path for imports
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "..")))

from app.malware_detection.malware_detector_prod import (
    MalwareDetectionModel,
    ProcessEvent,
    MalwareType
)


def generate_synthetic_malware_samples(n: int = 500) -> List[ProcessEvent]:
    """Generate synthetic process events for training"""
    import random
    
    events = []
    
    # Malicious patterns
    malicious_commands = [
        "powershell -nop -w hidden -encodedcommand",
        "cmd /c whoami && net user",
        "rundll32 shell32.dll,Control_RunDLL",
        "certutil -decode payload.txt payload.exe",
        "bitsadmin /transfer /download /priority high",
        "wmic process call create",
        "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run",
    ]
    
    malicious_paths = [
        "C:\\Windows\\Temp\\update.exe",
        "C:\\Users\\Public\\svchost.exe",
        "C:\\ProgramData\\malware.dll",
        "%APPDATA%\\Roaming\\crypto.exe",
    ]
    
    benign_commands = [
        "notepad.exe",
        "explorer.exe /select,C:\\Users",
        "taskmgr.exe",
        "chrome.exe --new-window",
    ]
    
    benign_paths = [
        "C:\\Windows\\System32\\notepad.exe",
        "C:\\Program Files\\Google\\Chrome\\chrome.exe",
        "C:\\Windows\\explorer.exe",
    ]
    
    for i in range(n):
        is_malware = random.random() < 0.3  # 30% malware
        
        if is_malware:
            event = ProcessEvent(
                process_name=random.choice(["svchost.exe", "rundll32.exe", "powershell.exe", "cmd.exe"]),
                process_path=random.choice(malicious_paths),
                command_line=random.choice(malicious_commands),
                parent_process_name=random.choice(["explorer.exe", "winlogon.exe", "services.exe"]),
                hash_md5=f"malware_{i:04d}",
                hash_sha256=f"sha256_malware_{i:04d}",
                registry_accesses=[
                    "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run",
                    "HKCU\\Software\\Classes\\exefile\\shell\\open\\command"
                ] if random.random() < 0.7 else [],
                file_operations=[
                    {"type": "create", "path": "C:\\Windows\\Temp\\payload.exe"},
                    {"type": "write", "path": "C:\\Users\\victim\\Documents\\ransom.txt"}
                ] if random.random() < 0.6 else [],
                network_connections=[
                    {"ip": "192.168.1.100", "port": "4444", "protocol": "tcp"}
                ] if random.random() < 0.5 else [],
                memory_injections=random.randint(0, 5) if random.random() < 0.4 else 0,
                privilege_escalations=random.randint(0, 3) if random.random() < 0.3 else 0,
                is_malware=True,
                malware_type=random.choice([
                    MalwareType.RANSOMWARE,
                    MalwareType.TROJAN,
                    MalwareType.ROOTKIT,
                    MalwareType.SPYWARE
                ])
            )
        else:
            event = ProcessEvent(
                process_name=random.choice(["notepad.exe", "chrome.exe", "explorer.exe", "taskmgr.exe"]),
                process_path=random.choice(benign_paths),
                command_line=random.choice(benign_commands),
                parent_process_name="explorer.exe",
                hash_md5=f"benign_{i:04d}",
                hash_sha256=f"sha256_benign_{i:04d}",
                registry_accesses=[],
                file_operations=[],
                network_connections=[],
                memory_injections=0,
                privilege_escalations=0,
                is_malware=False,
                malware_type=None
            )
        
        events.append(event)
    
    return events


def load_malware_data_from_dir(data_dir: str) -> List[ProcessEvent]:
    """Load process events from JSONL files"""
    events = []
    
    if not os.path.exists(data_dir):
        return events
    
    jsonl_files = glob.glob(os.path.join(data_dir, "*.jsonl"))
    
    for fpath in jsonl_files:
        try:
            with open(fpath, 'r') as f:
                for line in f:
                    data = json.loads(line)
                    
                    # Convert to ProcessEvent
                    event = ProcessEvent(
                        process_name=data.get("process_name", ""),
                        process_path=data.get("process_path", ""),
                        command_line=data.get("command_line", ""),
                        parent_process_name=data.get("parent_process_name", data.get("parent_process", "")),
                        hash_md5=data.get("hash_md5", data.get("md5_hash", "")),
                        hash_sha256=data.get("hash_sha256", data.get("sha256_hash", "")),
                        registry_accesses=data.get("registry_accesses", []),
                        file_operations=data.get("file_operations", []),
                        network_connections=data.get("network_connections", []),
                        memory_injections=data.get("memory_injections", 0),
                        privilege_escalations=data.get("privilege_escalations", 0),
                        is_malware=data.get("is_malware", False),
                        malware_type=MalwareType(data["malware_type"]) if data.get("malware_type") else None
                    )
                    events.append(event)
        except Exception as e:
            print(f"Error reading file {fpath}: {e}")
    
    return events


def train_malware_model(data_dir: str = None, output_dir: str = None):
    """Train malware detection model"""
    start = time.time()
    
    # Resolve output directory
    if output_dir:
        storage_dir = output_dir
    else:
        storage_dir = os.path.join(os.path.dirname(__file__), "..", "..", "artifacts", "saved")
    
    os.makedirs(storage_dir, exist_ok=True)
    
    print("=" * 60)
    print("Training Malware Detection Model")
    print("=" * 60)
    
    # Load or generate data
    events = []
    if data_dir:
        print(f"Loading data from: {data_dir}")
        events = load_malware_data_from_dir(data_dir)
    
    if not events:
        print("No data found, generating synthetic samples...")
        events = generate_synthetic_malware_samples(n=500)
    
    print(f"Total events: {len(events)}")
    print(f"Malware samples: {sum(1 for e in events if e.is_malware)}")
    print(f"Benign samples: {sum(1 for e in events if not e.is_malware)}")
    
    # Train model
    print("\nTraining model...")
    model = MalwareDetectionModel()
    training_results = model.train(events)
    
    print("\nTraining Results:")
    print(f"  Events trained: {training_results['events_trained']}")
    print(f"  Malware samples: {training_results['malware_samples']}")
    print(f"  Clean samples: {training_results['clean_samples']}")
    
    # Save model
    model_path = os.path.join(storage_dir, "malware_detection_latest.pkl")
    print(f"\nSaving model to: {model_path}")
    model.save(model_path)
    
    duration = time.time() - start
    
    result = {
        "model_path": os.path.abspath(model_path),
        "training_time_seconds": duration,
        "samples": {
            "total": len(events),
            "malware": training_results['malware_samples'],
            "benign": training_results['clean_samples']
        },
        "trained_at": datetime.now().isoformat()
    }
    
    # Save results
    results_path = os.path.join(storage_dir, "malware_training_results.json")
    with open(results_path, "w") as f:
        json.dump(result, f, indent=2)
    
    print(f"\nTraining completed in {duration:.2f}s")
    print(f"Results saved to: {results_path}")
    print("=" * 60)
    
    return result


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Train Malware Detection Model")
    parser.add_argument("--data-dir", type=str, help="Directory containing process event data (JSONL)")
    parser.add_argument("--output-dir", type=str, help="Directory to save trained model")
    args = parser.parse_args()
    
    results = train_malware_model(data_dir=args.data_dir, output_dir=args.output_dir)
    print("\nFinal Results:")
    print(json.dumps(results, indent=2))
